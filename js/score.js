/**
 * MNScore
 * User: liyifei
 * Date: 2017-07-06
 */

var NOTE_STEP = 6;                  // the mini space between two notes
var LINE_STEP = 2 * NOTE_STEP;      // the space between two lines
var LINE_HEIGHT = 8 * NOTE_STEP;    // the space of staff line
var LINE_INTERVAL = 7 * NOTE_STEP;
var STEP_NAMES = new Array("C", "D", "E", "F", "G", "A", "B");

//global variables
var option = {
    noteDurations : 8,              // default note duration of the user
    editorWidth : 30,               // the width of editor
    lineMeasureCount : 4            // the count of measure in each line
};

//svgs data
var svgs = {
    note1 : "M5,-0.9Q5.2,1.5 6.4,3Q7.6,4.4 9.2,4.2Q11.6,4.1 11.4,0.9Q11.2,-1.6 10,-3Q8.8,-4.4 7.2,-4.2Q6,-4 5.4,-3.3Q4.9,-2.6 5,-0.9M13.2,-4Q16.1,-2.9 16.4,0Q16.2,2.9 13.4,4Q10.7,5.1 8.3,5Q5.9,5.1 3.1,4Q0.3,2.9 0,0Q0.2,-2.9 2.9,-4Q5.7,-5.1 8,-5Q10.4,-5.1 13.2,-4",
    note2 : "M4.2,-0.95Q1.5,1 1.4,2.75Q1.35,3.55 2.4,3.65Q3.45,3.7 4.95,3.1Q6.45,2.5 7.95,1.45L10.6,-0.85Q11.65,-2.1 11.65,-3.05Q11.5,-3.65 10.75,-3.75Q9.25,-3.9 7.25,-2.9Q5.3,-1.85 4.2,-0.95M11.45,-4.85Q13.2,-3.4 13,-1.1Q12.75,1.55 10.1,3.4Q7.45,5.25 4.6,5.35Q2.95,5.5 1.6,4.75Q-0.2,3.3 0.05,1Q0.3,-1.7 2.9,-3.5Q5.5,-5.35 8.4,-5.45Q10.1,-5.6 11.45,-4.85",
    note4 : "M13,-1.55Q12.8,1.2 10.15,3.15Q7.4,5.1 4.4,5.2Q2.5,5.15 1.3,4.2Q0.05,3.15 0,1.45Q0.2,-1.15 2.85,-3.1Q5.45,-5.1 8.25,-5.2Q10.45,-5.25 11.65,-4.3Q12.95,-3.45 13,-1.55",
    tail8 : "M9.65,19.45Q9.6,22.6 8.45,25.45L6.2,30L5.6,30L7.35,25.85Q8.3,23.35 8.3,20.5Q8.15,17.1 6.05,14.4Q4.9,12.9 3.2,11.9Q1.5,10.9 -0.2,10.7L-0.2,11.5L-1.25,11.5L-1.25,0L-0.2,0L0.35,3.3Q0.7,5.15 2.2,7.05L6.8,12.25Q9.45,15.45 9.65,19.45",
    tail16 : "M6.85,9.95Q9.5,13.15 9.65,17.15Q9.65,19.15 9.05,21.1Q10.1,23.15 10.15,25.55Q10,29.75 8.1,32.6L7.45,32.6L8.7,29.7Q9.25,27.9 9.2,26.35L8.9,23.7Q8.6,22.55 7.6,21.3Q6.3,19.85 3.95,18.45L-0.2,15.85L-0.2,16.65L-1.25,16.65L-1.25,0L-0.2,0L0.2,2.45Q0.6,3.75 1.85,4.95Q4.9,7.6 6.85,9.95M7.55,18.75L8.5,20.15L8.6,17.55Q8.3,14.5 6.1,12.1Q3.5,9.25 -0.2,7.3Q-0.05,9.5 1.05,11.5Q2.15,13.45 3.5,14.7L5.85,16.85L7.55,18.75",
    quote: "M-0.45,-160L-0.45,-159.4Q-3.55,-153.95 -5.45,-148.8L-5.65,-148.25Q-7.6,-142.85 -7.35,-136.45Q-7,-130.65 -5.45,-124.5L-5.35,-124.15L-2.15,-112.05Q-0.6,-106.2 -0.45,-101.6Q-0.4,-93.45 -3.2,-88.65Q-4.15,-87.1 -5.45,-85.55Q-8.05,-82.6 -12.1,-79.9Q-8.05,-77 -5.45,-74Q-4.15,-72.45 -3.2,-70.85Q-0.4,-66 -0.45,-57.8Q-0.6,-53.25 -2.15,-47.4L-5.35,-35.3Q-7,-29 -7.35,-22.95Q-7.6,-16.55 -5.65,-11.2Q-3.7,-5.85 -0.45,-0.4L-0.45,0.15Q-6.45,-8.3 -8.95,-16.25Q-11.45,-24.2 -11.4,-30.8Q-11.25,-37.45 -9.8,-44.1L-6.85,-56.45Q-5.35,-62.2 -5.3,-66.2Q-5.35,-67.85 -5.65,-69.35Q-6.15,-71.75 -7.35,-73.8Q-9.3,-77.1 -12.5,-79.6L-12.5,-80.2Q-9.3,-82.45 -7.35,-85.7Q-5.85,-88.15 -5.45,-91.2L-5.3,-93.2L-5.45,-95.65Q-5.8,-98.9 -6.85,-102.95L-9.8,-115.35Q-11.25,-121.95 -11.4,-128.65Q-11.45,-135.25 -8.95,-143.25Q-7.65,-147.35 -5.45,-151.65Q-3.35,-155.75 -0.45,-160",
    //clef
    clefG: "M16.8,-41.3Q17.85,-39.35 18.65,-36.5Q19.45,-33.75 19.55,-31.35Q19.3,-22.85 12.95,-16.4L14.25,-9.7L15.8,-9.85Q19.7,-9.75 22.1,-6.9Q24.45,-4.05 24.5,-0.1Q24.45,3.15 22.7,5.45Q20.95,7.8 18.05,9.2L19.7,17.3L19.8,19.15Q19.6,25.45 12.95,26.35Q10.35,26.6 8.1,25.05Q5.85,23.5 5.45,20.8Q5.35,18.9 6.35,17.4Q7.4,15.95 9.2,15.65Q10.8,15.5 12,16.65Q13.2,17.75 13.3,19.45Q13.25,21.75 11.75,22.6Q10.25,23.5 9.2,23.25Q9.4,24.25 10.65,24.7L12.85,25Q18.35,24.15 18.45,19.05Q18.5,17.7 18.15,16.15L16.75,9.75L13.15,10.3Q7.85,10.15 4.2,6.4Q0.55,2.65 0,-3.15Q-0.2,-8.95 3.25,-13.5Q6.7,-18 10.6,-21.7Q9.45,-26.05 9.4,-30.55Q9.4,-33.6 10.75,-37.6Q12.1,-41.65 14.9,-43Q15.75,-43.2 16.8,-41.3M15.65,-37.1Q13.2,-36.35 12.15,-33.25Q11.1,-30.2 11.05,-27.75Q11.1,-25.2 11.75,-22.8Q14.2,-24.85 16.05,-27.95Q17.85,-31.1 17.8,-34.55Q17.8,-35.55 17.25,-36.3Q16.7,-37.05 15.65,-37.1M11.05,-2.85Q9.85,-1.35 9.85,0.55Q10.1,3.7 12.95,4.9L13.25,5.3L12.7,5.7Q10.4,4.85 8.95,2.9Q7.5,0.9 7.5,-1.65Q7.6,-4.2 9.2,-6.35Q10.8,-8.45 13.1,-9.35L11.9,-15.4Q8.55,-12.6 5.85,-9.05Q3.15,-5.55 2.95,-0.95Q3.1,3.8 6.25,6.4Q9.45,9.05 13.95,8.9L16.55,8.4L13.95,-4.9Q12.2,-4.35 11.05,-2.85M15.15,-5.05L17.8,8Q21.7,5.85 21.75,1.3Q21.5,-1.55 19.7,-3.25Q17.9,-5 15.15,-5.05",
    clefF: "M6.8,-8.15L4.75,-7Q4,-6.2 3.55,-5.2Q3.1,-4.2 4.5,-3.9L6.1,-4.25Q7.75,-4.35 8.8,-3.4Q9.9,-2.4 9.95,-1Q9.9,0.4 8.85,1.5Q7.8,2.6 5.9,2.65Q3.9,2.65 2.5,1.45Q1.15,0.3 1.05,-1.55Q1,-3.6 2.15,-5.45Q3.3,-7.25 5.25,-8.35Q6.35,-9 8,-9.5L10.9,-10Q14.7,-10.25 18.25,-7.5Q20.05,-6.05 20.85,-4.5Q21.6,-2.95 21.85,-0.5Q22.1,3.2 19.8,7.2Q17.55,11.15 14.5,13.65L7.85,18.05L0.25,22L0,21.15L7.85,15.65Q11.1,13.05 13.65,8.75Q14.8,6.75 15.5,4.25Q16.25,1.8 16.25,-0.35Q16.4,-3.55 15.3,-5.75Q14.55,-7.15 13.1,-8Q11.55,-8.9 9.55,-8.75L6.8,-8.15M25.65,-6.85Q27.7,-6.6 27.8,-4.7Q27.7,-2.75 25.65,-2.5Q23.5,-2.75 23.45,-4.7Q23.5,-6.6 25.65,-6.85M27.8,4.05Q27.7,6 25.65,6.25Q23.5,6 23.45,4.05Q23.5,2.15 25.65,1.9Q27.7,2.15 27.8,4.05",
    clefC: "M18.25,-20Q22.2,-19.95 24.6,-17.4Q26.9,-14.8 26.95,-10.5Q26.9,-7.05 24.95,-4.65Q23,-2.25 19.55,-1.9Q17.7,-1.7 15.35,-2.65L13.5,0.3L15.35,3.25Q17.7,2.3 19.55,2.5Q23,2.9 24.95,5.25Q26.9,7.65 27,11.1Q26.9,15.4 24.6,17.95Q22.2,20.55 18.25,20.6Q15.8,20.65 13.45,19.5Q11.1,18.45 10.95,15.7Q10.95,14.5 11.7,13.6Q12.45,12.75 13.6,12.7Q16.1,12.8 16.35,15.2Q16.25,16.5 15.5,17.1Q14.8,17.7 14.7,18.2Q14.75,18.9 15.6,19.15L17.05,19.4Q20.2,19.2 21,16.7Q21.85,14.2 21.65,11.6Q21.8,9.3 21.2,6.65Q20.65,4.05 17.7,4.05Q15.7,4.35 14.65,6.05Q13.65,7.8 13.45,9.7L13.35,9.7Q13,7.65 11.95,4.95Q10.8,2.25 8.6,0.65L8.6,20.6L7.05,20.6L7.05,-20L8.6,-20L8.6,-0.05Q10.8,-1.6 11.9,-4.35Q13,-7.1 13.35,-9.05L13.45,-9.05Q13.65,-7.2 14.65,-5.45Q15.7,-3.75 17.7,-3.45Q20.7,-3.45 21.25,-6.2Q21.8,-8.9 21.65,-11.25Q21.85,-14.05 21,-16.2Q20.2,-18.4 17.05,-18.75L15.6,-18.6Q14.75,-18.35 14.7,-17.6Q14.8,-17.15 15.5,-16.55Q16.25,-15.95 16.35,-14.65Q16.1,-12.25 13.6,-12.2Q11.15,-12.5 10.95,-15.15Q11.1,-17.9 13.45,-19Q15.85,-20.05 18.25,-20M4.7,-20L4.7,20.6L0,20.6L0,-20L4.7,-20",
    pause1 : "M14.972,12L-2.528,12L-2.528,-5.5L14.972,-5.5L14.972,12"    
};

//common methods
var MN = {};

//move svg element
MN.moveTo = function(obj, left, top) {
    obj.transform("t" + left + "," + top);
} 
//fill svg element
MN.fill = function(obj, color, optical) {
    var _color = "black";
    if (color) _color = color;
    obj.attr("fill", _color);
    obj.attr("stroke", _color);
    if (optical) obj.attr("opacity",optical);
}

//score
var MNScore = function(container, width, height) {
    this.raphael = new Raphael(container, width, height);
    this.bounds = new MNBounds(0, 0, width, height);
    this.lines = new MNSet();
    this.editor = new MNMeasureEditor(this);
    this.addLine();
    var a = this.raphael.path(svgs.clefG);
    MN.moveTo(a, 50, LINE_INTERVAL + 3 * LINE_STEP);
    MN.fill(a, "black");

    var b = this.raphael.path(svgs.clefF);
    MN.moveTo(b, 5, LINE_INTERVAL + 1 * LINE_STEP);
    MN.fill(b, "black");

    var c = this.raphael.path(svgs.clefC);
    MN.moveTo(c, 100, LINE_INTERVAL + 2 * LINE_STEP);
    MN.fill(c, "black");
}

//------------------------------
// method of score
//------------------------------
//add line to score
MNScore.prototype.addLine = function() {
    var newline = new MNLine(this);
    this.lines.add(newline);
    var height = this.getLinesHeight() + LINE_INTERVAL;
    //resize the score's size to show all lines
    if (this.raphael.height < height) {
        this.raphael.setSize(this.bounds.width, height);
    }
    return newline;
}

//get usable line from score, maybe create a new line
MNScore.prototype.getUsableLine = function() {
    var line = this.lines.getFirst();
    while (line && line.getMeasureCount() >= 4) {
        line = this.lines.getNext();
    }
    if (!line) {
        line = this.addLine();
    }
    return line;
}

//get the summary of all line's height 
MNScore.prototype.getLinesHeight = function() {
    return this.lines.getSummary("bounds", "height");
}

//get line's count
MNScore.prototype.getLineCount = function() {
    return this.lines.getCount();
}

//add measure to score
MNScore.prototype.addMeasure = function() {
    return this.getUsableLine().addMeasure();
}

//get the next note set
MNScore.prototype.getNextNoteSet = function() {

}

//get the previous note set
MNScore.prototype.getPreviousNoteSet = function() {
    
}
